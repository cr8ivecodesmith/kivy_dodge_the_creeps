#:kivy 1.11.0

#:include player.kv
#:include mob.kv
#:include hud.kv

#:import DodgeGame game.DodgeGame
#:import DodgeMobs mobs.DodgeMobs
#:import Hud hud.Hud

#:import CollisionSystem common.collision.CollisionSystem
#:import Keyboard common.keyboard.Keyboard
#:import Path2D common.path2d.Path2D
#:import RuntimeStats common.runtime_stats.RuntimeStats
#:import Timer common.timer.Timer

<DodgeGame>:

    # ============
    # INITIALIZERS
    # ============
    # Nodes or Systems with `initialize` methods that needs to run once.

    on_kv_post: player.initialize(*args)

    # ========
    # GAMELOOP
    # ========
    # Nodes or Systems with `process` methods that needs to run on every frame.

    Timer:
        id: processor
        delay: 1 / 60
        autoplay: True
        on_timeout: player.process(self.delta)
        on_timeout: mob_path.process(self.delta)
        on_timeout: collision_system.process(self.delta)

    # ============
    # GAME SYSTEMS
    # ============
    # General systems

    CollisionSystem:
        id: collision_system

    # ==========
    # MAIN NODES
    # ==========
    # Nodes attached to the game root.

    Hud:
        id: hud
        on_start_game: self.parent.new_game()

    DodgePlayer:
        id: player
        visible: False
        speed: 420
        on_body_entered: self.handle_body_entered(*args)
        on_hit: self.parent.game_over()

    DodgeMobs:
        id: mobs

    Path2D:
        id: mob_path

    Keyboard:
        id: keyboard
        on_key_release: player.on_key_release()
        on_key_press: player.on_key_press()
        on_key_press: hud.press_start()

    Timer:
        id: start_timer
        delay: 2
        oneshot: True
        on_timeout: self.parent.start_timer_timeout()

    Timer:
        id: score_timer
        delay: 1
        on_timeout: self.parent.score_timer_timeout()

    Timer:
        id: mob_timer
        delay: 0.5
        on_timeout: self.parent.mob_timer_timeout()

    RuntimeStats:
        show: True
